import { GoogleAIFileManager } from "@google/generative-ai/server";
import { GoogleGenerativeAI } from "@google/generative-ai";
import fs from 'fs/promises';
import ExcelJS from "exceljs";
import pdf2table from 'pdf2table';
import axios from 'axios';
import { resolve } from "path";
import https from 'https';
import dotenv from 'dotenv';
import { dirname } from 'path';
import { fileURLToPath } from 'url';
import path from 'path';




const __dirname = dirname(fileURLToPath(import.meta.url));

dotenv.config();

  // ç”¨æ–¼è™•ç† Excel æ–‡ä»¶

const genAI = new GoogleGenerativeAI(process.env.API_KEY);
const fileManager = new GoogleAIFileManager(process.env.API_KEY);


export async function uploadPDF(pcrFiles, productFiles){
  const carbonCSVContent = await fs.readFile(`${__dirname}/Preview_Data (1).csv`, 'utf-8');
  const prompt=await fs.readFile(`${__dirname}/å¡«è¡¨æ•™å­¸.txt`,'utf-8');
  const pull=await fs.readFile(`${__dirname}/ä¸‹æ‹‰å¼.txt`,'utf-8');
  const group=await fs.readFile(`${__dirname}/ç¾¤çµ„å®šç¾©.txt`,'utf-8');
  const model = genAI.getGenerativeModel({
    model: 'gemini-1.5-pro',
    
    generationConfig: {
      temperature: 0,
      topP: 1,
      topK: 1
    }
});
  const pcruploadResult = await fileManager.uploadFile(
    pcrFiles,
    {
      mimeType: "application/pdf",
    },
  );
  const useruploadResult = await fileManager.uploadFile(
    productFiles,
    {
      mimeType: "application/pdf",
    },
  );

  const exampleCSVContent = await fs.readFile(`${__dirname}/ç›¤æŸ¥é …ç›®ç¯„æœ¬.csv`, 'utf-8');
  // ç¬¬ä¸€éšæ®µï¼šä¸Šå‚³ PCR èˆ‡ PDFï¼Œè®“ Gemini æ“·å–å·²æä¾›è³‡æ–™
   const result1 = await model.generateContent([
  {
    fileData: { fileUri: pcruploadResult.file.uri, mimeType: pcruploadResult.file.mimeType }
  },
  {
    fileData: { fileUri: useruploadResult.file.uri, mimeType: useruploadResult.file.mimeType }
  },
`è«‹æ ¹æ“šæˆ‘æä¾›çš„ç¢³ç›¤æŸ¥å ±å‘Š PDFï¼Œæ‰¾å‡ºæœ¬å ±å‘Šä¸­è¨˜è¼‰çš„ã€Œæœ¬å¹´åº¦ç¸½ç”¢å“ç”¢é‡ã€æˆ–ã€Œç”Ÿç”¢æ•¸é‡ã€ã€‚  

è«‹ç›´æ¥ä»¥ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

{
  "ç¸½ç”¢å“ç”¢é‡": æ•¸å€¼,
  "å–®ä½": "åŸæ–‡å–®ä½"
}
`])
const extractedJSON0 = result1.response.text();
  const cleanJsonString0 = extractedJSON0
    .replace(/```json/g, '')
    .replace(/```/g, '')
    .trim();
console.log(cleanJsonString0);

const result = await model.generateContent([
  {
    fileData: { fileUri: pcruploadResult.file.uri, mimeType: pcruploadResult.file.mimeType }
  },
  {
    fileData: { fileUri: useruploadResult.file.uri, mimeType: useruploadResult.file.mimeType }
  },
  `${pull}`,
  `${cleanJsonString0}`,
  `${group}`,
  `
æˆ‘æä¾›äº†PCR æ–‡ä»¶ ${pcruploadResult}ï¼Œè«‹å…ˆå®Œæ•´é–±è®€ä¸¦ç†è§£å¦‚ä½•é€²è¡Œç”¢å“ç¢³ç›¤æŸ¥ã€‚æ¥è‘—é–±è®€æˆ‘æä¾›çš„ç¢³ç›¤æŸ¥å ±å‘Š PDF ${useruploadResult}ï¼Œä»¥åŠæˆ‘å‰›æ‰æä¾›çš„ä¸‹æ‹‰é¸å–® ${pull}ã€‚

è«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰å…§å®¹ï¼Œã€Œä»¥ JSON æ ¼å¼ç”¢å‡ºä¸€ä»½å¡«å¯«å®Œæ•´çš„ç¢³ç›¤æŸ¥è¡¨æ ¼ã€ï¼Œé€™ä»½è¡¨æ ¼å°‡è¢«ç”¨ä¾†å¡«å…¥ Excel è¡¨å–®ï¼Œå› æ­¤å¿…é ˆåš´æ ¼å°æ‡‰ä¸‹åˆ—æ¬„ä½èˆ‡æ ¼å¼ï¼Œä¸”åªå…è¨±å¡«å…¥ç¢³ç›¤æŸ¥å ±å‘Š PDF ä¸­æ˜ç¢ºæä¾›çš„è³‡è¨Šã€‚ç¦æ­¢å¾å…¶ä»–ä¾†æºè£œé½Šæˆ–æ¨æ¸¬ã€‚

è«‹åƒ…å›å‚³ JSON æ ¼å¼ï¼Œä¸å¾—åŒ…å«ä»»ä½•è§£é‡‹æ–‡å­—æˆ–è£œå……èªªæ˜ã€‚

âœ… è¡¨æ ¼æ¬„ä½çµæ§‹å¦‚ä¸‹ï¼ˆå°æ‡‰ Excelï¼‰ï¼š
Excel æ ¼å¼ JSON Key åç¨±
A2 "ç”Ÿå‘½é€±æœŸéšæ®µ"
B2 "ç¾¤çµ„"
C2 "åç¨±"
D2 "ç¸½æ´»å‹•é‡"
E2 "ç¸½æ´»å‹•é‡å–®ä½"
F2 "æ¯å–®ä½æ•¸é‡"
G2 "æ¯å–®ä½æ•¸é‡å–®ä½"
H2 "æ’æ”¾ä¿‚æ•¸åç¨±"
I2 "æ’æ”¾ä¿‚æ•¸æ•¸å€¼"
J2 "æ’æ”¾ä¿‚æ•¸å–®ä½"
K2 "æ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æº"
L2 "å‚™è¨»"

â— å¿…é ˆéµå®ˆçš„è¦å‰‡å¦‚ä¸‹ï¼š
ğŸ“Œ åœ¨é–‹å§‹æå–è³‡æ–™å‰ï¼Œè«‹å…ˆå¾ç¢³ç›¤æŸ¥å ±å‘Š PDF ä¸­æ‰¾å‡ºã€Œæœ¬å¹´åº¦ç”¢å“ç¸½ç”¢é‡ã€æˆ–ã€Œç¸½ç”Ÿç”¢æ•¸é‡ã€ï¼Œé€™å€‹æ•¸é‡å°‡ç”¨æ–¼è¨ˆç®—æ‰€æœ‰æ´»å‹•é …ç›®çš„ç¸½æ´»å‹•é‡ã€‚

è«‹å‹™å¿…éµå®ˆä»¥ä¸‹é‚è¼¯ï¼š

1. æ¯ç­†æ´»å‹•æ•¸æ“šä¸­ï¼š
  ç¸½ç”¢é‡${cleanJsonString0}
- ã€Œç¸½æ´»å‹•é‡ã€=ã€Œæ¯å–®ä½æ•¸é‡ã€Ã—ã€Œç”¢å“ç¸½ç”¢é‡ã€
- ç¦æ­¢ç›´æ¥å°‡æ¯å–®ä½æ•¸é‡å¡«å…¥ç¸½æ´»å‹•é‡æ¬„ä½
- ç¸½æ´»å‹•é‡å¿…é ˆæ˜¯æœ€çµ‚æ•¸å€¼ï¼Œç¦æ­¢å¯«æˆç®—å¼ï¼ˆå¦‚ 1030 Ã— 2530 âŒï¼‰


3. ã€Œæ’æ”¾ä¿‚æ•¸æ•¸å€¼ã€ã€Œæ’æ”¾ä¿‚æ•¸å–®ä½ã€ã€Œæ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æºã€ä¸‰æ¬„ï¼Œåªèƒ½å¡«å¯«ç›¤æŸ¥å ±å‘Š PDF ä¸­æ˜ç¢ºå‡ºç¾çš„å…§å®¹ã€‚ç¦æ­¢å¼•ç”¨å…¶ä»–ä¾†æºï¼ˆå¦‚è³‡æ–™åº«ã€å¤–éƒ¨ç¶²ç«™ã€ä½ è‡ªå·±çš„çŸ¥è­˜ï¼‰ä¾†è£œé½Šé€™äº›æ¬„ä½ï¼Œå°¤å…¶ã€Œæ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æºã€çš„éƒ¨åˆ†æ‡‰æ›´åŠ æ³¨æ„è«‹å‹¿å¡«å…¥ä»»ä½•ä½¿ç”¨è€…æœªèªªæ˜çš„ä¾†æºã€‚
  ğŸš« å³ä½¿ä½ çŸ¥é“æŸäº›è³‡æ–™ï¼Œä¹Ÿç¦æ­¢å¡«å¯«ã€‚ç¦æ­¢ä»»ä½•æƒ…æ³ä¸‹ä½¿ç”¨æ¨¡å‹è¨˜æ†¶ã€èªæ–™åº«ã€å¸¸è­˜ã€éå¾€å­¸ç¿’è³‡æ–™è£œå¡«æœ¬æ¬¡è¡¨æ ¼ä¸­çš„æ’æ”¾ä¿‚æ•¸æ¬„ä½ã€‚  
  âš ï¸ æ³¨æ„ï¼šã€Œæ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æºï¼ˆK æ¬„ï¼‰ã€é è¨­ç‚ºç©ºã€‚åªæœ‰åœ¨ç¢³ç›¤æŸ¥å ±å‘Š PDF ä¸­æ˜ç¢ºå‡ºç¾ä¾†æºèªªæ˜ï¼ˆå¦‚ï¼šã€Œæ•¸æ“šä¾†æºï¼šç’°å¢ƒéƒ¨ç”¢å“ç¢³è¶³è·¡è³‡è¨Šç¶²ã€ï¼‰æ™‚ï¼Œæ‰å¯ä»¥å¡«å…¥è©²ä¾†æºã€‚
  å³ä½¿ä½ çŸ¥é“æ­¤æ•¸å€¼å‡ºç¾åœ¨å¤–éƒ¨è³‡æ–™åº«ï¼Œè‹¥å ±å‘Šæœªæ˜è¼‰ä¾†æºè³‡è¨Šï¼Œè«‹å°‡ã€Œæ•¸æ“šä¾†æºã€æ¬„ä¿æŒç©ºç™½ã€‚

4. è‹¥å ±å‘Šä¸­æœªæä¾›è©²æ•¸æ“šï¼Œç¦æ­¢ä½¿ç”¨ã€Œç„¡ã€ã€ã€ŒæœªçŸ¥ã€ã€ã€Œå°šæœªæä¾›ã€ç­‰æ–‡å­—ï¼Œç•™ç©ºå³å¯ã€‚

 5. **æ¯å–®ä½æ•¸é‡ï¼ˆF æ¬„ï¼‰** æŒ‡çš„æ˜¯ï¼šç•¶ä¸€å€‹ç”¢å“çš„åŠŸèƒ½å–®ä½ç‚º 1ï¼ˆå¦‚ 1 å…¬å™¸ï¼‰ï¼Œæ´»å‹•æ•¸æ“šçš„ç¸½é‡é™¤ä»¥ç¸½ç”¢å“æ•¸é‡æ‰€å¾—çš„æ¯å–®ä½å€¼ï¼Œè«‹ç›´æ¥çµ¦å‡ºæ›ç®—å¾Œçš„æ•¸å€¼ï¼Œä¾‹å¦‚ï¼š
        -  æ­£ç¢ºï¼š1030
        -  éŒ¯èª¤ï¼š1030/11ï¼ˆä¸èƒ½å‡ºç¾ç®—å¼ï¼‰
        å¦‚æœå ±å‘Šä¸­æ²’æœ‰æ˜å¯«æ¯å–®ä½æ•¸é‡ï¼Œè«‹ç”¨ç¸½æ´»å‹•é‡é™¤ä»¥ç”¢å“ç¸½ç”¢é‡ä¾†è¨ˆç®—æ¯å–®ä½æ•¸é‡ã€‚

  6. **ç¸½æ´»å‹•é‡ï¼ˆD æ¬„ï¼‰** å¿…é ˆæ ¹æ“šã€Œæ¯å–®ä½æ•¸é‡ * ç¸½ç”¢é‡æˆ–ç¸½é‡é‡ã€ç›´æ¥ç®—å‡ºçµæœï¼Œä¸èƒ½å‡ºç¾è¨ˆç®—å¼ï¼Œè«‹ç›´æ¥å¡«å¥½ã€‚ä¾‹å¦‚ï¼š
        -  æ­£ç¢ºï¼š11330
        -  éŒ¯èª¤ï¼š1030 * 11
      ç¸½æ´»å‹•é‡é ˆè¬¹æ…æ³¨æ„è¦ç‘±å…¥çš„æ˜¯ã€Œæ¨™çš„ç”¢å“ç¸½æ´»å‹•é‡ã€ï¼Œè«‹è¬¹æ…åˆ¤æ–·è³‡æ–™æä¾›çš„æ˜¯ã€Œå…¨å» æ‰€æœ‰ç”¢å“ç¸½æ´»å‹•é‡ã€é‚„æ˜¯ã€Œæ¨™çš„ç”¢å“ç¸½æ´»å‹•é‡ã€ï¼Œè‹¥æ˜¯å…¨å» æ‰€æœ‰ç”¢å“ç¸½æ´»å‹•é‡å‰‡éœ€è¦è³‡æ–™ä¸­æœ‰æä¾›ã€Œæ¨™çš„ç”¢å“ä½”å…¨å» ç”¢å“æ¯”ä¾‹ã€ï¼Œä¸¦ç”±è©²æ¯”ä¾‹ä¹˜ä¸Šå…¨å» æ‰€æœ‰ç”¢å“ç¸½æ´»å‹•é‡æ‰èƒ½å¾—åˆ°æˆ‘è¦çš„ã€Œæ¨™çš„ç”¢å“ç¸½æ´»å‹•é‡ã€ã€‚
      è‹¥æœ‰æä¾›ç¸½æ´»å‹•é‡ä»¥åŠæ¯å–®ä½æ•¸é‡ä½†å…©è€…ä¹‹é–“ä¸¦ä¸ç¬¦åˆã€Œæ¯å–®ä½æ•¸é‡*ç¸½ç”¢é‡=ç¸½æ´»å‹•é‡ã€ï¼Œå‰‡è«‹ä»¥æ¯å–®ä½æ•¸é‡ç‚ºä¸»ä¸¦é‡æ–°è¨ˆç®—ç¸½æ´»å‹•é‡ã€‚

 7. æ³¨æ„ "ç¸½æ´»å‹•é‡" èˆ‡ "æ¯å–®ä½æ•¸é‡" çš„å·®åˆ¥ï¼Œä»¥åŠæ³¨æ„åŠŸèƒ½å–®ä½å¯èƒ½å¯«åœ¨å ±å‘Šè£¡çš„æŸä¸€è™•ã€‚

8. ã€Œæ’æ”¾ä¿‚æ•¸å–®ä½ã€éœ€ç‚ºåŠŸèƒ½å–®ä½ï¼ˆä¾‹å¦‚ã€Œå…¬æ–¤ COâ‚‚eï¼ç«‹æ–¹å…¬å°ºã€â†’ã€Œç«‹æ–¹å…¬å°ºã€ï¼‰ï¼Œä¸¦èˆ‡ä¸‹æ‹‰é¸å–®é¸é …ä¸€è‡´ã€‚

9. è‹¥å ±å‘Šä¸­åƒ…æä¾›æ’æ”¾ä¿‚æ•¸æ•¸å€¼ï¼ŒæœªæåŠä¾†æºï¼Œè«‹åƒ…å¡«å…¥æ•¸å€¼ï¼Œä¾†æºè«‹ä¿æŒç©ºç™½ã€‚è‹¥æŸä¸€ç­†è³‡æ–™ä¸­ï¼Œå ±å‘Šæœªæä¾›æ’æ”¾ä¿‚æ•¸è³‡è¨Šï¼ˆæ•¸å€¼ã€å–®ä½ã€ä¾†æºï¼‰ï¼Œè«‹ä¿æŒé€™ä¸‰å€‹æ¬„ä½ç‚ºç©ºã€‚è‹¥æœ‰æåŠæ’æ”¾ä¿‚æ•¸æ•¸å€¼ï¼Œå‰‡ä¹Ÿè«‹å‹™å¿…å¡«å¯«æ’æ”¾ä¿‚æ•¸åç¨±æ¬„ä½ã€‚

10. æ‰€æœ‰é¸é …ï¼ˆç”Ÿå‘½é€±æœŸéšæ®µã€ç¾¤çµ„ã€å–®ä½ï¼‰çš†å¿…é ˆåš´æ ¼å¾ ${pull} æä¾›çš„ä¸‹æ‹‰é¸å–®ä¸­é¸å–ï¼Œåš´æ ¼ç¦æ­¢ä»»ä½•è‡ªå‰µæˆ–ä¿®æ”¹ï¼Œä¾‹å¦‚ã€Œå…¬æ–¤ã€å‰‡éœ€é¸å–é¸å–®ä¸­å°æ‡‰çš„ã€Œå…¬æ–¤(kg)ã€ã€‚
  æ’æ”¾ä¿‚æ•¸çš„å–®ä½è‹¥æœ‰å¯«ã€ŒCOâ‚‚eï¼ã€å¾Œé¢æ¥ä¸Šå–®ä½ï¼Œå‰‡åªéœ€å¡«ä¸Šå¾Œé¢çš„å–®ä½å³å¯ã€‚ä¾‹å¦‚ï¼šã€ŒCOâ‚‚eï¼å…¬æ–¤ã€å‰‡å¡«ä¸Šã€Œå…¬æ–¤(kg)ã€ï¼Œã€ŒCOâ‚‚eï¼å»¶å™¸å…¬é‡Œã€å¡«ä¸Šã€Œå»¶å™¸å…¬é‡Œ(tkm)ã€ï¼Œä½†å¦‚æœå–®ä½åªæœ‰ã€ŒCOâ‚‚eã€ï¼Œé‚£å°±å¡«ä¸Šã€ŒCOâ‚‚eã€å°±å¥½ã€‚
  ï¼ˆç”Ÿå‘½é€±æœŸéšæ®µã€ç¾¤çµ„ã€å–®ä½ï¼‰ä¸­å¡«å…¥çš„è³‡æ–™éƒ½å¿…é ˆéå¸¸åš´æ ¼éµå®ˆèˆ‡ä¸‹æ‹‰é¸å–®æª”æ¡ˆä¸­çš„é¸é …ä¸€æ¨¡ä¸€æ¨£ï¼Œå¦å‰‡æœƒæœ‰åš´é‡éŒ¯èª¤ã€‚

11.ç¾¤çµ„æ¬„ä½ä¹‹å®šç¾©å¦‚${group}æ‰€ç¤º

ğŸ” æƒæèˆ‡æ“·å–åŸå‰‡ï¼š
è«‹å®Œæ•´æƒææ•´ä»½ Qcake ç¢³ç›¤æŸ¥å ±å‘Šèˆ‡ PCR æ–‡ä»¶ï¼Œé€é é€æ®µæª¢æŸ¥æ‰€æœ‰èˆ‡æ´»å‹•æ•¸æ“šæœ‰é—œçš„å…§å®¹ã€‚

æ´»å‹•æ•¸æ“šæ˜¯æŒ‡ä»»ä½•å°è‡´ç¢³æ’çš„æ´»å‹•ï¼Œä¾‹å¦‚ï¼š

åŸç‰©æ–™èˆ‡åŠ å·¥å“

èƒ½æºï¼ˆé›»ã€è’¸æ±½ã€ç‡ƒæ–™ç­‰ï¼‰

åŒ…è£ææ–™èˆ‡åŒ…è£å»¢æ£„ç‰©

å†·åª’ã€è£½å†·è¨­å‚™ã€æ°´è³‡æº

å»¢æ£„ç‰©è™•ç†

é‹è¼¸èˆ‡ç‰©æµé…é€

éŠ·å”®ã€å„²å­˜èˆ‡ç”¢å“å¾Œè™•ç†

å³ä½¿åƒ…åœ¨å ±å‘ŠæŸè™•ç°¡å–®æåŠï¼Œä¹Ÿå¿…é ˆæå–ç‚ºä¸€ç­†è³‡æ–™ã€‚

è«‹å°‡ä¸Šè¿°æ‰€æœ‰è³‡è¨Šè½‰æ›ç‚º JSON é™£åˆ—æ ¼å¼çš„è³‡æ–™è¡¨ï¼Œæ¯åˆ—å°æ‡‰ä¸€ç­†æ´»å‹•ã€‚è«‹å‹¿åŒ…å«ä»»ä½•é¡å¤–èªªæ˜ã€è¨»è§£æˆ–æ¨™é ­æ–‡å­—ï¼Œäº¦ä¸éœ€åŒ…å«ç¸½ç”¢é‡è³‡æ–™ï¼Œè«‹åš´æ ¼éµå®ˆæˆ‘æä¾›çš„jsonæ ¼å¼ã€‚


  `
]);

const extractedJSON = result.response.text();
  const cleanJsonString1 = extractedJSON
    .replace(/```json/g, '')
    .replace(/```/g, '')
    .trim();
console.log(cleanJsonString1);
// ç¬¬äºŒéšæ®µï¼šè£œé½Šç¼ºæ¼çš„æ’æ”¾ä¿‚æ•¸
const filledResult = await model.generateContent([
  `${pull}`,
  `${carbonCSVContent}`,
  `
ä»¥ä¸‹æ˜¯å¾å ±å‘Šä¸­æ“·å–å‡ºçš„ JSON è³‡æ–™ï¼š
${cleanJsonString1}

è«‹æ ¹æ“šä»¥ä¸‹è¦å‰‡ï¼Œ**åƒ…è£œé½Šç©ºç™½çš„æ’æ”¾ä¿‚æ•¸æ¬„ä½**ï¼Œä¸¦åš´æ ¼ç¦æ­¢ä»»ä½•è¦†å¯«å·²å¡«å¯«éçš„è³‡æ–™ï¼š

ğŸ”’ã€åš´æ ¼ç¦æ­¢ä¿®æ”¹åŸè³‡æ–™ã€‘
1. è‹¥æŸç­†è³‡æ–™ä¸­ã€Œæ’æ”¾ä¿‚æ•¸æ•¸å€¼ã€(Iæ¬„) å·²ç¶“æœ‰å…§å®¹ï¼Œè«‹**çµ•å°ç¦æ­¢æ›´å‹•ä¸‹åˆ—æ¬„ä½**ï¼Œä¸è«–æ˜¯å¦ç¬¦åˆè³‡æ–™åº«å…§å®¹ï¼Œä¹Ÿä¸è«–æ•¸å€¼æ˜¯å¦æ­£ç¢ºï¼š
   - "æ’æ”¾ä¿‚æ•¸åç¨±" (Hæ¬„)
   - "æ’æ”¾ä¿‚æ•¸æ•¸å€¼" (Iæ¬„)
   - "æ’æ”¾ä¿‚æ•¸å–®ä½" (Jæ¬„)
   - "æ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æº" (Kæ¬„)
   - âš ï¸ ä¸å…è¨±ä»»ä½•æƒ…æ³ä¸‹è¦†è“‹é€™å››æ¬„ï¼Œå³ä½¿è³‡æ–™åº«ä¸­æœ‰çœ‹ä¼¼æ›´åˆé©çš„å…§å®¹ã€‚
   - âš ï¸ åœ¨ã€Œæ’æ”¾ä¿‚æ•¸æ•¸å€¼ã€(Iæ¬„) å·²ç¶“æœ‰å…§å®¹çš„æƒ…æ³ä¸‹ï¼Œå³ä½¿"æ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æº"ç‚ºç©ºæ¬„ä¹Ÿåš´æ ¼ç¦æ­¢å¡«å…¥è³‡æ–™ã€‚

âœ…ã€å…è¨±è£œé½Šç©ºæ¬„ã€‘
2. åƒ…ç•¶ã€Œæ’æ”¾ä¿‚æ•¸æ•¸å€¼ã€(Iæ¬„) ç‚ºç©ºæ™‚ï¼Œæ‰å…è¨±å¾æˆ‘æä¾›çš„æ’æ”¾ä¿‚æ•¸è³‡æ–™åº«ï¼ˆ${carbonCSVContent}ï¼‰ä¸­é€²è¡Œè£œé½Šã€‚è£œé½Šæ¢ä»¶å¦‚ä¸‹ï¼š
   - æ ¹æ“šæ¬„ä½ã€Œåç¨±ã€ï¼ˆCæ¬„ï¼‰å°æ‡‰æŸ¥æ‰¾è³‡æ–™åº«ä¸­çš„ã€Œé …ç›®åç¨±ã€
   - åƒ…é¸ç”¨æ’æ”¾ä¿‚æ•¸è¡¨ä¸­ã€Œå®£å‘Šå–®ä½ã€èˆ‡ JSON ä¸­ã€Œæ¯å–®ä½æ•¸é‡å–®ä½ã€(Gæ¬„) å®Œå…¨ä¸€è‡´çš„è³‡æ–™
   - è‹¥æ‰¾ä¸åˆ°å–®ä½ä¸€è‡´çš„è³‡æ–™ï¼Œå‰‡è©²ç­†è³‡æ–™çš„æ’æ”¾ä¿‚æ•¸ä¸‰æ¬„ä¿æŒç©ºç™½

ğŸ“Œ è£œé½Šå…§å®¹æ‡‰åŒ…å«ï¼š
   - "æ’æ”¾ä¿‚æ•¸åç¨±" â†’ å°æ‡‰è³‡æ–™åº«ä¸­åç¨±
   - "æ’æ”¾ä¿‚æ•¸æ•¸å€¼" â†’ è³‡æ–™åº«ä¸­æœ€æ–°å¹´åº¦çš„æ•¸å€¼
   - "æ’æ”¾ä¿‚æ•¸å–®ä½" â†’ åƒ…å¯é¸æ“‡ ${pull} ä¸­æä¾›çš„åŠŸèƒ½å–®ä½
   - "æ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æº" â†’ ä½¿ç”¨æ ¼å¼ï¼šã€Œç’°å¢ƒéƒ¨,2023ã€ï¼ˆå°æ‡‰è³‡æ–™åº«çš„ department èˆ‡ announcementyearï¼‰

â›” ç¦æ­¢ä»»ä½•è‡ªå‰µæˆ–æ¨æ¸¬è¡Œç‚ºï¼Œç¦æ­¢æ ¹æ“šèªæ„ã€ŒçŒœä½ èªç‚ºåˆé©çš„ã€è£œé½Šï¼Œè‹¥ä¸ç¬¦åˆæ¢ä»¶ï¼Œè«‹ä¿ç•™ç©ºç™½ã€‚

â›” ä¸å¯èª¿æ•´æˆ–æ ¼å¼åŒ–åŸæœ‰è³‡æ–™ï¼Œå³ä½¿ä½ è¦ºå¾—çµæœæ¯”è¼ƒæ•´é½Šæˆ–ä¸€è‡´ï¼Œä¹Ÿè«‹ä¿ç•™åŸå§‹æ ¼å¼ä¸å‹•ã€‚

è«‹åƒ…å›å‚³ JSON é™£åˆ—æ ¼å¼ï¼Œä¸å¾—åŒ…å«ä»»ä½•è§£é‡‹æ–‡å­—ã€è¨»è§£ã€èªªæ˜æˆ–æç¤ºã€‚

âœ… è¡¨æ ¼æ¬„ä½å¦‚ä¸‹ï¼š
A2 "ç”Ÿå‘½é€±æœŸéšæ®µ"
B2 "ç¾¤çµ„"
C2 "åç¨±"
D2 "ç¸½æ´»å‹•é‡"
E2 "ç¸½æ´»å‹•é‡å–®ä½"
F2 "æ¯å–®ä½æ•¸é‡"
G2 "æ¯å–®ä½æ•¸é‡å–®ä½"
H2 "æ’æ”¾ä¿‚æ•¸åç¨±"
I2 "æ’æ”¾ä¿‚æ•¸æ•¸å€¼"
J2 "æ’æ”¾ä¿‚æ•¸å–®ä½"
K2 "æ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æº"
L2 "å‚™è¨»"
`
]);


const finalJSON = filledResult.response.text();

  const cleanJsonString = finalJSON
    .replace(/```json/g, '')
    .replace(/```/g, '')
    .trim();

  return cleanJsonString;
}


async function generateExcel(datain) {
  let data=datain;

    if (!Array.isArray(data)) {
      throw new Error('å‚³å…¥çš„è³‡æ–™ä¸æ˜¯é™£åˆ—');
    }
    console.log("æ”¶åˆ° Excel è³‡æ–™ï¼š", data);
    const workbook = new ExcelJS.Workbook();
    const ws_main = workbook.addWorksheet('Sheet1');
    const ws_dropdown = workbook.addWorksheet('Code');
  
    // ä¸‹æ‹‰é¸å–®å…§å®¹ï¼ˆç”Ÿå‘½é€±æœŸéšæ®µã€ç¾¤çµ„ã€å–®ä½ï¼‰
    const dropdowns = {
      "ç”Ÿå‘½é€±æœŸéšæ®µ": [
        'åŸæ–™å–å¾—éšæ®µ', 'è£½é€ ç”Ÿç”¢éšæ®µ', 'é…éŠ·éšæ®µ', 'ä½¿ç”¨éšæ®µ', 'å»¢æ£„è™•ç†éšæ®µ', 'æœå‹™éšæ®µ'
      ],
      "ç¾¤çµ„": [
        'èƒ½æº', 'è³‡æº', 'åŸç‰©æ–™', 'è¼”åŠ©é …', 'ç”¢å“', 'è¯ç”¢å“', 'æ’æ”¾', 'æ®˜ç•™ç‰©'
      ],
      "å–®ä½": [
        'æ¯«ç±³(mm)', 'å…¬åˆ†(cm)', 'å…¬å°º(m)', 'å…¬é‡Œ(km)', 'æµ·æµ¬(nm)', 'è‹±å¯¸(in)', 'ç¢¼(yard)',
        'æ¯«å…‹(mg)', 'å…¬å…‹(g)', 'å…¬æ–¤(kg)', 'å…¬å™¸(mt)', 'è‹±ç£…(lb)', 'æ¯«å‡(ml)', 'å…¬å‡(L)', 'å…¬ç§‰(kl)',
        'å¹³æ–¹æ¯«ç±³(mm2)', 'å¹³æ–¹å…¬åˆ†(cm2)', 'å¹³æ–¹å…¬å°º(m2)', 'å¹³æ–¹å…¬é‡Œ(km2)', 'ç«‹æ–¹æ¯«ç±³(mm3)', 'ç«‹æ–¹å…¬åˆ†(cm3)',
        'ç«‹æ–¹å…¬å°º(m3)', 'ç«‹æ–¹å…¬é‡Œ(km3)', 'ç™¾è¬ç„¦è€³(MJ)', 'åº¦(kwh)', 'å»¶äººå…¬é‡Œ(pkm)', 'å»¶å™¸å…¬é‡Œ(tkm)',
        'g CO2e', 'kg CO2e', 'æ¯å¹³æ–¹ç±³â€§æ¯å°æ™‚', 'æ¯äººâ€§æ¯å°æ™‚', 'æ¯äºº', 'æ¯äººæ¬¡', 'æ¯æˆ¿-æ¯å¤©',
        'ç‰‡', 'é¡†', 'å€‹', 'æ¢', 'å·', 'ç“¶', 'æ¡¶', 'ç›’', 'åŒ…', 'ç½', 'å°', 'é›™'
      ]
    };
  
    // å¯«å…¥é¸å–®å…§å®¹åˆ°å·¥ä½œè¡¨ Code
    dropdowns["ç”Ÿå‘½é€±æœŸéšæ®µ"].forEach((v, i) => ws_dropdown.getCell(`A${i + 1}`).value = v);
    dropdowns["ç¾¤çµ„"].forEach((v, i) => ws_dropdown.getCell(`C${i + 1}`).value = v);
    dropdowns["å–®ä½"].forEach((v, i) => ws_dropdown.getCell(`E${i + 1}`).value = v);
    dropdowns["å–®ä½"].forEach((v, i) => ws_dropdown.getCell(`G${i + 1}`).value = v);
    dropdowns["å–®ä½"].forEach((v, i) => ws_dropdown.getCell(`J${i + 1}`).value = v);

    // ä¸»è¡¨æ¨™é¡Œè¨­ç½®
    ws_main.mergeCells('A1:G1');
    ws_main.getCell('A1').value = 'æ´»å‹•æ•¸æ“š';
    ws_main.mergeCells('H1:K1');
    ws_main.getCell('H1').value = 'æ’æ”¾ä¿‚æ•¸';
  
    const headers = [
      'ç”Ÿå‘½é€±æœŸéšæ®µ', 'ç¾¤çµ„', 'åç¨±', 'ç¸½æ´»å‹•é‡', 'å–®ä½', 'æ¯å–®ä½æ•¸é‡', 'å–®ä½',
      'æ’æ”¾åç¨±', 'æ•¸å€¼', 'å–®ä½', 'æ•¸æ“šä¾†æº', 'å‚™è¨»'
    ];
    ws_main.addRow(headers);
    ws_main.mergeCells('L1:L2');
    ws_main.getCell('L1').value = 'å‚™è¨»';
    // å¯«å…¥è³‡æ–™å…§å®¹
    data.forEach(item => {
      ws_main.addRow([
        item['ç”Ÿå‘½é€±æœŸéšæ®µ'],
        item['ç¾¤çµ„'],
        item['åç¨±'],
        item['ç¸½æ´»å‹•é‡'],
        item['ç¸½æ´»å‹•é‡å–®ä½'],
        item['æ¯å–®ä½æ•¸é‡'],
        item['æ¯å–®ä½æ•¸é‡å–®ä½'],
        item['æ’æ”¾ä¿‚æ•¸åç¨±'],
        item['æ’æ”¾ä¿‚æ•¸æ•¸å€¼'],
        item['æ’æ”¾ä¿‚æ•¸å–®ä½'],
        item['æ’æ”¾ä¿‚æ•¸æ•¸æ“šä¾†æº'],
        item['å‚™è¨»'] || ''
      ]);
    });
  
    // å»ºç«‹è³‡æ–™é©—è­‰å…¬å¼
    const unitFormula = `Code!$G$1:$G$${dropdowns["å–®ä½"].length}`;
    const lifecycleFormula = `Code!$A$1:$A$${dropdowns["ç”Ÿå‘½é€±æœŸéšæ®µ"].length}`;
    const groupFormula = `Code!$C$1:$C$${dropdowns["ç¾¤çµ„"].length}`;
  
    const rowStart = 3;
    const rowEnd = data.length + 2;
    for (let r = rowStart; r <= rowEnd; r++) {
      ws_main.getCell(`A${r}`).dataValidation = {
        type: 'list', formulae: [lifecycleFormula], allowBlank: true
      };
      ws_main.getCell(`B${r}`).dataValidation = {
        type: 'list', formulae: [groupFormula], allowBlank: true
      };
      ['E', 'G', 'J'].forEach(col => {
        ws_main.getCell(`${col}${r}`).dataValidation = {
          type: 'list', formulae: [unitFormula], allowBlank: true
        };
      });
    }
  
    await workbook.xlsx.writeFile(path.join(__dirname, 'generated', 'Carbon_Footprint_Report.xlsx'));

    console.log('Excel æ–‡ä»¶å«é¸å–®å·²ç”Ÿæˆ');
  }
  
  

async function main(){
    
    const text=await uploadPDF();
    await generateExcel(text);
}

//main();

export { generateExcel };